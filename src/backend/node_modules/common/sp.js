/**
 * @file utils
 * @author lzheng
 */
// https://www.npmjs.com/package/shell-task

var _ = require('lodash')

'use strict'

var cp = require('child_process')

function shellpromise(processToRun, options) {
    options = options || {}
    if (options.verbose) {
        console.log(processToRun)
    }
    return new Promise(function (resolve, reject) {
        cp
            .exec(processToRun, {
                encoding: 'utf8',
                env: options.env || process.env, cwd: options.cwd || process.cwd()
            }, function (error, stdout, stderr) {
                if (error) {
                    reject(error)
                }
                if (options.verbose && stdout) {
                    console.log(stdout)
                }
                if (options.verbose && stderr) {
                    console.error(stderr)
                }

                resolve(stdout)
            })
            .on('exit', function (code) {
                if (code !== 0) {
                    reject(new Error(processToRun + ' exited with exit code ' + code))
                }
                resolve()
            })
    })
}


var sp = function (command, opts) {
    return shellpromise(command, _.extend({ verbose: true }, opts))
}

module.exports = sp
